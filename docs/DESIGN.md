# カネミエル（KANEMIEL）システム設計書

> **Guardian of your cash flow**
> 建設業向け 現場キャッシュフロー管理システム

---

## 1. プロジェクト概要

### 1-1. サービス情報

| 項目 | 内容 |
|------|------|
| サービス名 | カネミエル（KANEMIEL） |
| タグライン | Guardian of your cash flow |
| 対象業種 | 建設業（左官業をメインターゲット） |
| GitHub | `https://github.com/TaigaSorimachi/kanemiel` |
| デモ | `https://taigasorimachi.github.io/kanemiel/` |

### 1-2. ブランドデザイン

| 要素 | 値 |
|------|-----|
| Primary | Navy `#0C1929` |
| Primary Mid | `#162544` |
| Primary Light | `#1E3355` |
| Accent | Gold `#C9A84C` |
| Accent Light | `#E8D48B` |
| Success | Green `#22B573` |
| Warning | Yellow `#E5A117` |
| Danger | Red `#E04343` |
| Background | `#F4F6FA` |
| Sub Text | `#6B7A90` |
| ロゴモチーフ | 盾（シールド）＋ 翼 ＋ ¥マーク |
| 英字フォント | Cormorant Garamond（セリフ・高級感） |
| 日本語フォント | Noto Sans JP |
| 数字フォント | DM Sans |

### 1-3. コンセプト

> **「今月、大丈夫？」が3秒でわかる**

- 信号機方式（🟢🟡🔴）で一目で資金状態を把握
- IT が苦手な経営者・現場監督でもスマホでかんたん操作
- LINE 連携で通知・認証をシームレスに

---

## 2. 課題と解決方針

### 2-1. ヒアリング済みの課題

| # | 課題 | リスク |
|---|------|--------|
| 1 | 現場単位のキャッシュフローを会社として把握できていない | 🔴 高 |
| 2 | 支払い判断が現場監督に寄っており、統制が弱い | 🔴 高 |
| 3 | 元請入金は最後だが、委託先への支払いが先行し資金ショートリスク | 🔴 高 |

### 2-2. 潜在的な課題

| # | 潜在課題 | リスク |
|---|---------|--------|
| 4 | 全社横断の資金状況が見えない | 🔴 高 |
| 5 | 支払いの二重計上・漏れ | 🟡 中 |
| 6 | 予算と実績の乖離に気づけない | 🟡 中 |
| 7 | 過去データの蓄積がない | 🟡 中 |
| 8 | 入金遅延への対応が後手 | 🔴 高 |
| 9 | 承認なしの立替・仮払い | 🟡 中 |
| 10 | 手形・ファクタリング判断の根拠不足 | 🟡 中 |
| 11 | 経営者が外出先で確認できない | 🟡 中 |

---

## 3. ユーザーロールと権限

### 3-1. ロール定義

| ロール | 代表 | 主な操作 | デバイス |
|--------|------|---------|---------|
| **経営者（Owner）** | 社長・専務 | ダッシュボード確認、最終承認 | スマホ中心 |
| **経理担当（Accounting）** | 事務員 | 入出金登録、承認処理、帳票出力 | PC中心 |
| **現場監督（Foreman）** | 親方・職長 | 支払申請、実績入力 | スマホ中心 |

### 3-2. 権限マトリクス

| 機能 | 経営者 | 経理 | 現場監督 |
|------|--------|------|---------|
| ダッシュボード（全社） | ✅ | ✅ | ❌ |
| ダッシュボード（担当現場のみ） | - | - | ✅ |
| 3ヶ月シグナル（全社） | ✅ | ✅ | ❌ |
| 3ヶ月シグナル（現場別） | ✅ | ✅ | ✅（担当のみ） |
| 残高推移チャート | ✅ | ✅ | ❌ |
| アラート一覧 | ✅ | ✅ | ❌ |
| 現場一覧（全件） | ✅ | ✅ | ❌ |
| 現場一覧（担当のみ） | - | - | ✅ |
| 現場詳細 | ✅（全件） | ✅（全件） | ✅（担当のみ） |
| 支払い承認 | ✅ | ✅ | ❌ |
| 支払い申請作成 | ❌ | ✅ | ✅ |
| 入金登録 | ❌ | ✅ | ❌ |
| レポート（全体サマリ） | ✅ | ✅ | ❌ |
| レポート（現場別収支） | ✅ | ✅ | ✅（担当のみ） |
| レポート（資金繰り表） | ✅ | ✅ | ❌ |
| 設定 | ✅ | ✅ | ✅（限定） |

### 3-3. 現場監督の制限事項

- **自分が担当する現場のデータのみ** 閲覧可能
- 他現場のデータ、会社全体の残高は参照不可
- 承認画面へのアクセス不可
- 通知ベルの承認バッジは非表示

---

## 4. 画面設計

### 4-1. 画面一覧

| # | 画面名 | パス（案） | ボトムナビ |
|---|--------|-----------|-----------|
| 1 | ダッシュボード | `/` | 🏠 トップ |
| 2 | 承認待ち一覧 | `/approval` | ✅ 承認 |
| 3 | 入力（支払申請/入金登録） | `/input` | ＋ 入力 |
| 4 | レポート | `/report` | 📊 レポート |
| 5 | 設定 | `/settings` | ⚙️ 設定 |
| 6 | 現場詳細（モーダル） | - | - |

### 4-2. ダッシュボード画面

**構成要素（上から順）：**

1. **残高カード** — 会社全体（または担当現場）の現在残高を大きく表示
   - 背景: Navy グラデーション
   - 金額: 40px 太字
   - 「LIVE」バッジ
   - 日付表示
2. **3ヶ月シグナル** — 今月/来月/再来月の収支予測を信号機で表示
   - 🟢 安全（残高 > 危険ライン × 2）
   - 🟡 注意（残高 > 危険ライン だが余裕少）
   - 🔴 危険（残高 ≤ 危険ライン）
   - 選択中のシグナルはゴールド枠でハイライト
3. **残高推移チャート** — 3ヶ月先までの残高推移を折れ線グラフで表示
   - ゴールドの折れ線 + エリア
   - 赤い破線で「危険ライン」を表示
4. **アラート一覧** — 要対応の項目を左ボーダー色つきカードで表示
   - 赤ボーダー: 緊急（承認待ち、資金不足予測）
   - 黄ボーダー: 注意（入金遅延）
5. **現場一覧** — 全現場の一覧カード
   - 信号ドット + 現場名 + 残高
   - 入金進捗のプログレスバー
   - タップで詳細モーダルを開く

### 4-3. 承認待ち画面

- **サマリバー**: 未承認件数 + 合計金額
- **承認カード**（各件）:
  - 現場名、支払先、金額（大きく表示）
  - メタ情報: 区分、希望日、申請者
  - **影響プレビュー**: 承認後の現場残高 + 会社残高を信号付きで表示
    - 安全（green背景）/ 注意（yellow背景）
  - アクションボタン: 「✓ 承認」（Navy + Gold）/「✕ 差戻し」（Red背景）
- 承認後はカードがフェードアウトし「✓ 承認しました」に置換

### 4-4. 入力画面

**2つのモード（トグル切替）:**

#### A. 支払い申請

| フィールド | 入力方式 | 必須 |
|-----------|---------|------|
| 現場 | 4ボタン選択（アイコン付き） | ✅ |
| 支払先 | 3ボタン + 「＋新規追加」 | ✅ |
| 金額 | 数値入力 + クイック金額ボタン（10万/30万/50万/80万/100万/150万） | ✅ |
| 支払希望日 | 日付ピッカー（デフォルト: 次月15日） | ✅ |
| 区分 | 5ボタン選択（👷外注費/🧱材料費/🚜機材/🚗交通費/📦その他） | ✅ |
| 備考 | テキスト入力 | - |
| 写真 | カメラ/画像選択 | - |

- **リアルタイム影響プレビュー**: 金額入力に連動して「承認後の残高」を表示
- **送信ボタン**: 全必須項目入力で有効化

#### B. 入金登録

| フィールド | 入力方式 | 必須 |
|-----------|---------|------|
| 現場 | 4ボタン選択 | ✅ |
| 入金元 | ボタン選択 + 新規追加 | ✅ |
| 金額 | 数値入力 | ✅ |
| 入金日 | 日付ピッカー | - |
| 種別 | 3ボタン（📄出来高/💰前受金/✅最終金） | - |

### 4-5. レポート画面

**3タブ構成:**

#### Tab 1: 全体サマリ
- KPIカード4枚（入金合計/支出合計/今月収支/承認待ち）
- 月別収支推移チャート（棒グラフ5ヶ月分）
- 現場別健全度（プログレスバー + 信号機）

#### Tab 2: 現場別収支
- テーブル: 現場/契約/入金/支出/残高/状態
- 合計行付き
- 支出区分の内訳（積み上げバー + レジェンド）

#### Tab 3: 資金繰り表
- 月次資金繰り表（4ヶ月分）
  - 月初残高
  - 入金合計（元請入金 / その他）
  - 支出合計（外注費 / 材料費 / その他）
  - 月末残高
  - 信号ステータス
- 危険月のアラートボックス

### 4-6. 設定画面

- 表示モード（ロール表示）
- LINE通知 ON/OFF
- 危険ライン金額設定
- バージョン表示

### 4-7. 現場詳細モーダル

- ボトムシート形式
- 現場名、信号ステータス
- 契約金額、入金済み、支出済み、現場残高
- 入出金タイムライン（日付・入出金・金額のリスト）

### 4-8. 共通UI要素

- **成功オーバーレイ**: 申請・登録完了時にフルスクリーンで「✓」アニメーション表示（1.8秒後に自動閉じ）
- **トースト通知**: 承認完了・ロール切替時にヘッダー下にゴールドのトースト
- **ボトムナビ**: 5タブ固定（トップ/承認/入力/レポート/設定）
- **ヘッダー**: ロゴ + 通知ベル（バッジ付き）+ メニュー

---

## 5. LINE 連携設計

### 5-1. 認証

- LINE LIFF でログイン（パスワード不要）
- LINE ユーザーID でアカウントを紐づけ
- 新規アカウント登録不要

### 5-2. 通知テンプレート

#### 毎朝8時 日次サマリ
```
━━━━━━━━━━━━━
📊 本日の資金状況
━━━━━━━━━━━━━
会社残高：1,520万円 🟢
承認待ち：2件（合計180万円）
今週の支払予定：350万円
今週の入金予定：500万円
━━━━━━━━━━━━━
[詳しく見る]
```

#### 承認依頼（都度）
```
━━━━━━━━━━━━━
🔔 支払い承認のお願い
━━━━━━━━━━━━━
A現場 → ○○工業
金額：80万円（外注費）
申請者：田中

承認後の残高：
  A現場：+370万🟢
  会社全体：+240万🟢
━━━━━━━━━━━━━
[承認する] [詳細を見る]
```

#### 危険アラート（即時）
```
━━━━━━━━━━━━━
🔴 資金アラート
━━━━━━━━━━━━━
来月15日時点で
残高が -180万円 になる
見込みです。

対象現場：C現場、D現場
━━━━━━━━━━━━━
[対策を確認する]
```

#### 月次レポート（月末）
```
━━━━━━━━━━━━━
📊 月次レポート（2月分）
━━━━━━━━━━━━━
入金：820万円
支出：500万円
収支：+320万円

現場別状況：
A現場 🟢 / B現場 🟢
C現場 🟡 / D現場 🔴
━━━━━━━━━━━━━
[詳細レポートを見る]
```

---

## 6. データベース設計（概要）

### 6-1. ER図（主要テーブル）

```
[companies] 会社
  │
  ├── [users] ユーザー
  │     └── role: owner / accounting / foreman
  │
  ├── [projects] 現場
  │     ├── [income_schedules] 入金予定
  │     ├── [expense_schedules] 支出予定
  │     ├── [payment_requests] 支払申請
  │     │     └── [approval_logs] 承認履歴
  │     ├── [transactions] 入出金実績
  │     └── [budgets] 予算（Phase2）
  │
  ├── [clients] 取引先マスタ
  │     └── type: general_contractor / subcontractor
  │
  └── [notifications] 通知
```

### 6-2. 主要テーブル定義

#### companies（会社）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | PK |
| name | String | 会社名 |
| bank_balance | Decimal | 現在の銀行残高 |
| danger_line | Decimal | 危険ライン金額（デフォルト200万） |
| created_at | DateTime | 作成日時 |
| updated_at | DateTime | 更新日時 |

#### users（ユーザー）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | PK |
| company_id | UUID | FK → companies |
| name | String | 氏名 |
| role | Enum | owner / accounting / foreman |
| line_user_id | String | LINE ユーザーID |
| line_notification | Boolean | 通知ON/OFF |
| created_at | DateTime | 作成日時 |

#### projects（現場）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | PK |
| company_id | UUID | FK → companies |
| name | String | 現場名 |
| client_id | UUID | FK → clients（元請け） |
| contract_amount | Decimal | 契約金額 |
| status | Enum | active / completed / paused |
| foreman_id | UUID | FK → users（担当監督） |
| start_date | Date | 着工日 |
| end_date | Date | 完工予定日 |
| created_at | DateTime | 作成日時 |

#### clients（取引先）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | PK |
| company_id | UUID | FK → companies |
| name | String | 取引先名 |
| type | Enum | general_contractor / subcontractor |
| payment_terms | String | 支払条件（例: 月末締め翌月末払い） |
| created_at | DateTime | 作成日時 |

#### income_schedules（入金予定）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | PK |
| project_id | UUID | FK → projects |
| client_id | UUID | FK → clients |
| amount | Decimal | 金額 |
| scheduled_date | Date | 入金予定日 |
| income_type | Enum | progress / advance / final |
| status | Enum | scheduled / received / overdue |
| actual_date | Date | 実入金日 |
| created_at | DateTime | 作成日時 |

#### payment_requests（支払申請）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | PK |
| project_id | UUID | FK → projects |
| requester_id | UUID | FK → users |
| client_id | UUID | FK → clients（支払先） |
| amount | Decimal | 金額 |
| category | Enum | subcontracting / material / equipment / transport / other |
| desired_date | Date | 支払希望日 |
| status | Enum | pending / approved / rejected / paid |
| note | String | 備考 |
| photo_url | String | 添付写真URL |
| created_at | DateTime | 作成日時 |

#### approval_logs（承認履歴）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | PK |
| request_id | UUID | FK → payment_requests |
| approver_id | UUID | FK → users |
| action | Enum | approved / rejected |
| comment | String | コメント |
| created_at | DateTime | 承認日時 |

#### transactions（入出金実績）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | PK |
| project_id | UUID | FK → projects |
| type | Enum | income / expense |
| amount | Decimal | 金額 |
| date | Date | 入出金日 |
| category | String | 区分 |
| client_id | UUID | FK → clients |
| description | String | 摘要 |
| created_at | DateTime | 作成日時 |

#### notifications（通知）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | PK |
| user_id | UUID | FK → users |
| type | Enum | approval_request / danger_alert / daily_summary / overdue |
| title | String | タイトル |
| message | String | メッセージ本文 |
| is_read | Boolean | 既読フラグ |
| link_url | String | 遷移先URL |
| sent_via_line | Boolean | LINE送信済み |
| created_at | DateTime | 作成日時 |

---

## 7. 技術スタック

| レイヤー | 技術 | バージョン | 理由 |
|---------|------|-----------|------|
| フロントエンド | Next.js (React) | 14+ | App Router、スマホ対応レスポンシブ |
| CSS | Tailwind CSS | 3+ | ユーティリティファースト |
| チャート | Recharts | - | React ネイティブ統合 |
| バックエンド | NestJS + TypeScript | 10+ | 堅牢なAPI設計 |
| ORM | Prisma | 5+ | 型安全なDB操作 |
| DB | PostgreSQL | 15+ | 信頼性の高いRDB |
| 認証 | LINE LIFF SDK | - | LINEログイン |
| 通知 | LINE Messaging API | - | プッシュ通知 |
| ホスティング | Vercel（Frontend） | - | Next.js最適化 |
| ホスティング | Railway（Backend/DB） | - | 低コスト運用 |
| コンテナ | Docker Compose | - | 開発環境統一 |

---

## 8. API 設計（主要エンドポイント）

### 認証
| メソッド | パス | 説明 |
|---------|------|------|
| POST | `/api/auth/line` | LINE LIFF 認証 |
| GET | `/api/auth/me` | ログインユーザー情報 |

### ダッシュボード
| メソッド | パス | 説明 |
|---------|------|------|
| GET | `/api/dashboard` | ダッシュボードデータ一括取得 |
| GET | `/api/dashboard/signals` | 3ヶ月シグナル |
| GET | `/api/dashboard/chart` | 残高推移チャートデータ |
| GET | `/api/dashboard/alerts` | アラート一覧 |

### 現場
| メソッド | パス | 説明 |
|---------|------|------|
| GET | `/api/projects` | 現場一覧 |
| GET | `/api/projects/:id` | 現場詳細 |
| POST | `/api/projects` | 現場作成 |
| PATCH | `/api/projects/:id` | 現場更新 |
| GET | `/api/projects/:id/timeline` | 入出金タイムライン |

### 支払申請
| メソッド | パス | 説明 |
|---------|------|------|
| GET | `/api/payment-requests` | 申請一覧 |
| GET | `/api/payment-requests/pending` | 承認待ち一覧 |
| POST | `/api/payment-requests` | 申請作成 |
| POST | `/api/payment-requests/:id/approve` | 承認 |
| POST | `/api/payment-requests/:id/reject` | 差戻し |
| GET | `/api/payment-requests/:id/impact` | 承認影響プレビュー |

### 入出金
| メソッド | パス | 説明 |
|---------|------|------|
| GET | `/api/transactions` | 入出金実績一覧 |
| POST | `/api/transactions/income` | 入金登録 |
| GET | `/api/income-schedules` | 入金予定一覧 |
| POST | `/api/income-schedules` | 入金予定登録 |

### レポート
| メソッド | パス | 説明 |
|---------|------|------|
| GET | `/api/reports/summary` | 全体サマリ |
| GET | `/api/reports/by-project` | 現場別収支 |
| GET | `/api/reports/cashflow-table` | 資金繰り表 |

### 取引先
| メソッド | パス | 説明 |
|---------|------|------|
| GET | `/api/clients` | 取引先一覧 |
| POST | `/api/clients` | 取引先追加 |

### 通知
| メソッド | パス | 説明 |
|---------|------|------|
| GET | `/api/notifications` | 通知一覧 |
| PATCH | `/api/notifications/:id/read` | 既読 |

---

## 9. ビジネスロジック

### 9-1. 信号判定ロジック

```
危険ライン = company.danger_line（デフォルト200万円）

月末予測残高 = 現在残高 + 当月入金予定 - 当月支出予定 - 承認済み支払い

if 月末予測残高 > 危険ライン × 2:
  🟢 安全
elif 月末予測残高 > 危険ライン:
  🟡 注意
else:
  🔴 危険
```

### 9-2. 承認ワークフロー

```
支払申請のステータス遷移:

pending（申請中）
  ├── → approved（承認）: 経理または経営者が承認
  ├── → rejected（差戻し）: 経理または経営者が差戻し
  └── → (pending のまま): 未対応

approved（承認済み）
  └── → paid（支払済み）: 経理が支払実行を記録
```

### 9-3. 影響プレビュー計算

```
承認影響プレビュー:
  現場残高（承認後） = 現場の入金合計 - 現場の支出合計 - 申請金額
  会社残高（承認後） = 会社残高 - 申請金額
```

### 9-4. 入金遅延検知

```
毎日バッチ（or cron）:
  income_schedules WHERE scheduled_date < today AND status = 'scheduled'
  → status を 'overdue' に更新
  → 経営者・経理に LINE 通知
```

---

## 10. 開発フェーズ

### Phase 1: MVP（6-8週間）

目標: 最小限の機能で実運用開始

- DB設計・基盤構築
- 現場・取引先マスタ管理
- 入出金予定登録
- 支払申請・承認ワークフロー
- ダッシュボード
- LINE認証・通知

### Phase 2: 分析・予測（定着後 4-6週間）

- 予算 vs 実績管理
- 入金遅延アラート
- 3ヶ月キャッシュフロー予測

### Phase 3: 高度化（データ蓄積後 4-6週間）

- 類似工事の履歴分析
- PDF/Excelレポート出力
- 会計ソフト連携

---

## 11. 他システムとの関係

```
┌──────────────────┐     ┌──────────────────┐
│   左官システム     │     │   カネミエル       │
│  （HR/現場管理）   │────▶│  （資金管理）      │
│                  │     │                  │
│ ・作業員マッチング │     │ ・キャッシュフロー  │
│ ・勤怠管理       │ 共有 │ ・支払承認         │
│ ・現場管理       │────▶│ ・資金繰り予測     │
│ ・日報管理       │     │ ・LINE通知         │
└──────────────────┘     └──────────────────┘
         │                        │
         └────── 共通基盤 ─────────┘
         ・認証（LINE LIFF）
         ・ユーザー管理
         ・現場マスタ
         ・取引先マスタ
```

将来的に左官システムと統合する場合、共通基盤（認証・マスタ）を共有する設計を推奨。

---

## 12. ITリテラシー配慮設計

| 工夫 | 具体策 |
|------|-------|
| 信号機方式 | すべての数値に🟢🟡🔴を付け、読まなくても色で判断可能 |
| 大きなボタン | タップしやすい最低48px以上のタッチターゲット |
| 選択式入力 | テキスト入力を最小限にし、ボタン選択を多用 |
| 日本語のみ | UIの英語表記を排除 |
| 手順の最小化 | 支払申請は最短3タップで完了 |
| 確認ダイアログ | 重要操作は確認を必ず表示 |
| 元に戻せる安心感 | 申請の取消し・修正が簡単にできる |
| LINE起点 | 通知から直接該当画面に遷移 |
